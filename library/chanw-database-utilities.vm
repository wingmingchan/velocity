#*doc
《code》
《copyright》
Author: Wing Ming Chan
Copyright (c) 2017 Wing Ming Chan <chanw@upstate.edu>
MIT Licensed
Modification history:
11/16/2017 Added #chanwGetRecordListFromSql.
10/2/2017 Added #chanwGetColumnLabelsFromRS and fixed a bug in #chanwGetHTMLTableFromResultSet.
8/7/2017 Started using macro names as namespace prefixes for local parameters.
8/3/2017 Fixed a bug in #chanwGetAllTableNames.
7/12/2017 Added import and evaluate elements.
4/26/2017 Added #chanwGetUserCountAuditByActionDays.
4/18/2017 Changed Statement to readonly.
4/10/2017 Fixed bugs in #chanwGetHTMLTableFromResultSet.
          Added #chanwGetIdCachepathBySqlSiteName, #chanwGetIdCachepathWithSpaceBySiteName,
          #chanwGetIdCachepathWithUppercaseCharBySiteName.
4/6/2017 Simplified the code of #chanwGetNumberOfRecordsInResultSet.
         Added #chanwGetBlockOrphanIdCachepathBySiteName and
         #chanwGetFileOrphanIdCachepathBySiteName.
3/31/2017 Added #chanwGetRecordListFromResultSet, #chanwGetIndexableChildrenIdTypeMap,
          #chanwGetAssetInfoById, #chanwGetAssetById, #chanwGetSiteIdBySiteName,
          #chanwGetSiteNameBySiteId,
          and rewrote #chanwGetHTMLTableFromResultSet.
1/12/2017 Added more code for Oracle
1/9/2017 Added #chanwGetAllTableNames
《/copyright》
《evaluate execute=“true”》
《div id=“hide-code1”》
《h2》Test Code and Results《/h2》
《pre》
=============================================================
$DOUBLE_HASH Display the number of entries in the cxml_foldercontent table
#import( 'core/library/velocity/chanw/chanw-database-utilities' )
${SINGLE_HASH}chanwGetNumberOfRecordsInTable( "cxml_foldercontent" )
#chanwGetNumberOfRecordsInTable( "cxml_foldercontent" )
${DOLLAR}chanwGetNumberOfRecordsInTable: $chanwGetNumberOfRecordsInTable
=============================================================
##chanwGetAllTableNames
##$chanwGetAllTableNames
=============================================================
#chanwCleanUp
《/pre》
《/div》
《/evaluate》
《documentation id=“top”》
《h2》Introduction《/h2》
《p》This format defines utility macros to access the Cascade database. At the end
of the format using this library format, put in 《code》#chanwCleanUp《/code》
as the last line of the code.《/p》
《p class=“text_red”》Important: Before importing the library, set the variable
《code》$chanwOracleDB《/code》 to 《code》false《/code》 if your database is
MySql or Microsoft SQL Server:《/p》
《pre》#set( $chanwOracleDB = false )
#import( 'site://mycore/formats/library/velocity/chanw-library-import' )
《/pre》
《p》Also note that table names used in SQL statement are case-sensitive.
Use uppercase for Oracle, and lowercase for MySql.《/p》
《/documentation》
《import》
doc*###
#import( 'core/library/velocity/chanw/chanw-initialization' )
#*doc
《/import》
《global-variables》
doc*###
## strings used in tables of DB
#set( $CASCADE_TABLE_TYPE_ASSET_TYPE_MAP = {
    "BLO" : $CASCADE_API_BLOCK_TYPE,
    "FIL" : $CASCADE_API_FILE_TYPE,
    "FOL" : $CASCADE_API_FOLDER_TYPE,
    "PAG" : $CASCADE_API_PAGE_TYPE,
    "REF" : $CASCADE_API_REFERENCE_TYPE,
    "SYM" : $CASCADE_API_SYMLINK_TYPE
} )
## element to Cascade type map
#set( $CASCADE_TYPE_ELEMENT_MAP = {
    "system-block":  $CASCADE_API_BLOCK_TYPE,
    "system-file":   $CASCADE_API_FILE_TYPE,
    "system-folder": $CASCADE_API_FOLDER_TYPE,
    "system-page":   $CASCADE_API_PAGE_TYPE,
    "system-symlink":$CASCADE_API_SYMLINK_TYPE
} )
#set( $chanwDatabaseUtilitiesGlobalVariables = [ 
    "chanwAssetCachePath",
    "chanwAssetSiteName",
    "chanwAssetType",
    "chanwColumnCount",
    "chanwConnection",
    "chanwContext",
    "chanwData",
    "chanwDataSource",
    "chanwDBMetadata",
    "chanwDBMetadataRS",
    "chanwFolderId",
    "chanwGetAllTableNames",
    "chanwGetAssetById",
    "chanwGetAssetInfoById",
    "chanwGetBlockOrphanIdCachepathBySiteName",
    "chanwGetDatabasStatement",
    "chanwGetFileOrphanIdCachepathBySiteName",
    "chanwGetHTMLTableFromSql",
    "chanwGetIdCachepathBySqlSiteName",
    "chanwGetIdCachepathWithSpaceBySiteName",
    "chanwGetIdCachepathWithUppercaseCharBySiteName",
    "chanwGetIndexableChildrenIdTypeMap",
    "chanwGetMetaDataRS",
    "chanwGetNumberOfRecordsInResultSet",
    "chanwGetNumberOfRecordsInTable",
    "chanwGetRecordListFromResultSet",
    "chanwGetResultSet",
    "chanwGetSiteIdBySiteName",
    "chanwGetSiteNameBySiteId",
    "chanwGetTableColumnNames",
    "chanwGetUserCountAuditByActionDays",
    "chanwLastRecordNumber",
    "chanwMetaData",
    "chanwNumberOfRecords",
    "chanwOracleDB",
    "chanwPastCalendarObject",
    "chanwPastDateObject",
    "chanwPastTimestamp",
    "chanwRecord",
    "chanwRecordList",
    "chanwResultSet",
    "chanwResultSetColumnCount",
    "chanwResultSetMetadata",
    "chanwSql",
    "sqlBlockOrphan",
    "sqlFileOrphan",
    "sqlCachepathWithSpace",
    "sqlCachepathWithUppercaseChar"
] )
##
#if( !$chanwOracleDB.Class.Name )
    #set( $chanwOracleDB = true )  ## defaulted to Oracle
#end
##
## SQL statements that work for both Oracle and MySql
#set( $sqlCachepathWithSpace = "select f.id, f.cachepath from cxml_foldercontent f " +
    "where f.cachepath like '% %' and f.iscurrentversion=1 and f.siteid=" +
    "(select s.id from cxml_site s where s.name='-siteName-')" )
#set( $sqlCachepathWithUppercaseChar = "select f.id, f.cachepath from cxml_foldercontent f " +
    "where not(lower(f.cachepath)=f.cachepath)  and f.siteid=" +
    "(select s.id from cxml_site s where s.name='-siteName-') " )
#set( $sqlBlockOrphan = "select f.* from (select id, cachepath from cxml_foldercontent " +
    "where siteid=(select id from cxml_site where name='-siteName-') and assettype='BLO' " +
    "and iscurrentversion=1) f left join cxml_structureddata sd on f.id = sd.blockid " +
    "where sd.blockid is null" )
#set( $sqlFileOrphan = "select id, cachepath from cxml_foldercontent where id in " +
    "(select fc1.id from ((select f.id from (select id, cachepath from cxml_foldercontent " +
    "where siteid=(select id from cxml_site where name='-siteName-') and assettype='FIL' " +
    "and iscurrentversion=1) f left join cxml_structureddata sd on f.id = sd.fileid " +
    "where sd.fileid is null ) fc1 join (select ff.id from (select id, cachepath from cxml_foldercontent " +
    "where siteid=(select id from cxml_site where name='-siteName-') and assettype='FIL' " +
    "and iscurrentversion=1) ff left join cxml_entityrelation er on ff.id = er.fileid " +
    "where er.fileid is null) fc2 on fc1.id=fc2.id))" )
#*doc
《/global-variables》
《documentation》
《code》#chanwCheckResultSet( $rs )《/code》
《p》Checks the variable 《code》$rs《/code》 to make sure that it is associated
with a valid result set. This macro is used by other macros.《/p》
《/documentation》
《macro id=“chanwCheckResultSet”》
doc*###
#macro( chanwCheckResultSet $chanwCheckResultSetRs )
    #chanwIsInstanceOf( $chanwCheckResultSetRs $JAVA_SQL_RESULT_SET_CLASS_NAME )
##
    #if( !$chanwIsInstanceOf )
    A ResultSet object is required.
    #stop
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwCheckStatement( $stmt )《/code》
《p》Checks the variable 《code》$stmt《/code》 to make sure that it is associated
with a valid statement. This macro is used by other macros.《/p》
《/documentation》
《macro id=“chanwCheckStatement”》
doc*###
#macro( chanwCheckStatement $chanwCheckStatementStmt )
    #chanwIsInstanceOf( $chanwCheckStatementStmt $JAVA_SQL_STATEMENT_CLASS_NAME )
##
    #if( !$chanwIsInstanceOf )
    A Statement object is required.
    #stop
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwCleanUp《/code》
《p》Cleans up the connection and statement objects. Note that once this macro
is invoked, the connection to the database is closed. To open the connecton again,
invoke 《code》#chanwGetDatabaseStatement《/code》 like this:《/p》
《pre》
#if( !$chanwConnection || $chanwConnection.isClosed() )
    #chanwGetDatabaseStatement
#end
《/pre》
《/documentation》
《macro id=“chanwCleanUp”》
doc*###
#macro( chanwCleanUp )
    #if( $chanwConnection )
        ##still open
        $chanwConnection.close()
    #end
##
    #if( $chanwGetDatabaseStatement )
        $chanwGetDatabaseStatement.close()
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwCreateDatabasePHPCode( $data )《/code》
《p》Creates PHP code containing a variable named 《code》$view《/code》,
pointing to an array of values drawn from the result set 《code》$data《/code》.
The first column of the view must be keys, and the view must have at least two
columns. The resulting code is stored in 《code》$globalStringBuffer《/code》.
To build a one-column list, use 《code》#chanwGetDatabaseList《/code》 instead.
Example:《/p》
《pre》
#import( 'site://_core/formats/library/velocity/chanw-library-import' )

#set( $sql  = "SELECT userName, email, fullName FROM cxml_user" )
#chanwGetResultSet( $sql )
#chanwCreateDatabasePHPCode( $chanwGetResultSet )
$globalStringBuffer.toString()
《/pre》
《p》The PHP code generated will be something like:《/p》
《pre》
$view=array(
"wing"=&gt; array("wing@upstate.edu","Wing"),);
《/pre》
《p》To use the PHP code, publish the code in an XML page, then read the page
contents using the page URL. Once the code is read, replace all instances of
《code》&gt;《/code》 with 《code》<《/code》, and then evaluate the code.
The variable 《code》$view《/code》 will be associated with an associative array,
with usernames as keys and emails and full names as values.《/p》
《/documentation》
《macro id=“chanwCreateDatabasePHPCode”》
doc*###
#macro( chanwCreateDatabasePHPCode $chanwCreateDatabasePHPCodeData )
    #chanwCheckResultSet( $chanwCreateDatabasePHPCodeData )
##
    #if( $chanwCreateDatabasePHPCodeData.last() )
        #set( $chanwLastRecordNumber = $chanwCreateDatabasePHPCodeData.Row )
    #end
##
    #set( $chanwColumnCount = $chanwCreateDatabasePHPCodeData.getMetaData().getColumnCount() )
    $globalStringBuffer.setLength( 0 )
    #set( $void = $globalStringBuffer.append( '$view=array(' ) )
##
    #if( $chanwLastRecordNumber > 0 )
        #set( $void = $chanwCreateDatabasePHPCodeData.first() )
        ## the code is formatted in this way to avoid too much space within 
        ## foreach to avoid hanging
        ## the first record
        #foreach( $count in [ 1..$chanwColumnCount ] )##
            #if( $count == 1 )#set(
                $void = $globalStringBuffer.append( '"' ).append( $chanwCreateDatabasePHPCodeData.getString(##
                $count ) ).append( '"=>array(' ) )##
            #else#set( $void = $globalStringBuffer.append( '"' ).append(##
                $chanwCreateDatabasePHPCodeData.getString( $count ) ).append( '"' ) )##
                #if( $count == $chanwColumnCount )#set( $void = $globalStringBuffer.append( ")," ) )##
                #else#set( $void = $globalStringBuffer.append( "," ) )##
                #end##
            #end##
        #end##
##
## loop through all remaining records
#foreach( $i in [ 2..$chanwLastRecordNumber ] )##
#set( $void = $chanwCreateDatabasePHPCodeData.next() )##
#foreach( $j in [ 1..$chanwColumnCount ] )##
#if( $j == 1 )#set( $void = $globalStringBuffer.append( '"' ).append(##
$chanwCreateDatabasePHPCodeData.getString( $j ) ).append( '"=>array(' ) )##
#else##
#set( $void = $globalStringBuffer.append( '"' ).append(##
$chanwCreateDatabasePHPCodeData.getString( $j ) ).append( '"' ) )##
#if( $j == $chanwColumnCount )##
#set( $void = $globalStringBuffer.append( ")," ) )##
#else##
#set( $void = $globalStringBuffer.append( "," ) )##
#end##
#end##
#end##
#end##
#end##
##
    #set( $void = $globalStringBuffer.append( ");" ) )
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetAllTableNames《/code》
《p》Creates a global variable named 《code》$chanwGetAllTableNames《/code》, which
stores all table names. Example:《/p》
《pre》
#chanwGetAllTableNames
$chanwGetAllTableNames
《/pre》
《/documentation》
《macro id=“chanwGetAllTableNames”》
doc*###
#macro( chanwGetAllTableNames )
    #if( !$chanwConnection || $chanwConnection.isClosed() )
        #chanwGetDatabaseStatement
    #end
    ## Oracle
    #if( $chanwOracleDB )
        #set( $chanwGetAllTableNames = [] )
        #set( $chanwSql = "SELECT tablespace_name, table_name FROM all_tables " +
             "WHERE tablespace_name LIKE 'C%' " +
             "AND table_name like 'CXML_%' " +
             "ORDER BY table_name" )
##
        #chanwGetResultSet( $chanwSql )
##
        #if( $chanwGetResultSet.next() )
            #set( $chanwTableName = '"' + $chanwGetResultSet.getString( 2 ).toLowerCase() + '"' )
            #set( $void = $chanwGetAllTableNames.add( $chanwTableName ) )
##
            #foreach( $num in [ 1..500 ] )
                #if( $chanwGetResultSet.next() )
                    #set( $chanwTableName = '"' + $chanwGetResultSet.getString( 2 ).toLowerCase() + '"' )
                    #set( $void = $chanwGetAllTableNames.add( $chanwTableName ) )
                #else
                    #break
                #end
            #end
        #end
    ## MySQL
    #else
        #set( $chanwDBMetadata    = $chanwConnection.getMetaData() )
        #set( $chanwDBMetadataRS  = $chanwDBMetadata.getTables( null, null, "%", null ) )
        #set( $chanwGetAllTableNames = [] )
##
        #if( $chanwDBMetadataRS.next() )
            #if( $chanwDBMetadataRS.getString( 3 ).startsWith( "cxml_" ) )
                #set( $chanwTableName = '"' + $chanwDBMetadataRS.getString( 3 ).toLowerCase() + '"' )
                #set( $void = $chanwGetAllTableNames.add( $chanwTableName ) )
            #end
##
            #foreach( $num in [ 1..500 ] )
                #if( $chanwDBMetadataRS.next() )
                    #if( $chanwDBMetadataRS.getString( 3 ).startsWith( "cxml_" ) )
                        #set( $chanwTableName = '"' + $chanwDBMetadataRS.getString( 3 ).toLowerCase() + '"' )
                        #set( $void = $chanwGetAllTableNames.add( $chanwTableName ) )
                    #end
                #else
                    #break
                #end
            #end
        #end
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetAssetById( $id )《/code》
《p》Returns the asset (a Cascade API object) bearing that id. Example:《/p》
《pre》
#chanwGetAssetById( '8d3a06308b7f08ee37c14fb2544459d1' )
$chanwGetAssetById.Class.Name
《/pre》
《/documentation》
《macro id=“chanwGetAssetById”》
doc*###
#macro( chanwGetAssetById $chanwGetAssetByIdId )
    #set( $chanwGetAssetById = "" )
    #chanwGetAssetInfoById( $chanwGetAssetByIdId )
##
    #if( $chanwAssetCachePath != "" )
        #set( $chanwGetAssetById = $_.locate( $chanwAssetCachePath, $chanwAssetType, $chanwAssetSiteName ) )
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetAssetInfoById( $id )《/code》
《p》Returns 《code》$chanwGetAssetInfoById《/code》, a list of values related to
the asset bearing that id. Besides populating the list, three other variables
are also created: 《code》$chanwAssetCachePath《/code》 (storing the path),
《code》$chanwAssetType《/code》 (storing the type), and
《code》$chanwAssetSiteName《/code》 (storing the site name). Example:《/p》
《pre》
#chanwGetAssetInfoById( '8d3a06308b7f08ee37c14fb2544459d1' )
$chanwGetAssetInfoById
《/pre》
《/documentation》
《macro id=“chanwGetAssetInfoById”》
doc*###
#macro( chanwGetAssetInfoById $chanwGetAssetInfoByIdId )
    #set( $chanwGetAssetInfoById = "" )
    #set( $chanwAssetCachePath   = "" )
    #set( $chanwAssetType        = "" )
    #set( $chanwAssetSiteName    = "" )
    #set( $chanwGetAssetInfoById = [] )
    #set( $chanwSql = "select f.CACHEPATH, f.ASSETTYPE, s.name from cxml_foldercontent f, cxml_site s where f.id='$chanwGetAssetInfoByIdId' and f.SITEID=s.id" )
    #chanwGetResultSet( $chanwSql )
    #chanwGetRecordListFromResultSet( $chanwGetResultSet )
##
    #if( $chanwGetRecordListFromResultSet.size() > 1 )
        #set( $chanwRecord           = $chanwGetRecordListFromResultSet.get( 1 ) )
        #set( $chanwAssetCachePath   = $chanwRecord.get( 0 ) )
        #set( $void                  = $chanwGetAssetInfoById.add( $chanwAssetCachePath ) )
        #set( $chanwAssetType        = $CASCADE_TABLE_TYPE_ASSET_TYPE_MAP.get( $chanwRecord.get( 1 ) ) )
        #set( $void                  = $chanwGetAssetInfoById.add( $chanwAssetType ) )
        #set( $chanwAssetSiteName    = $chanwRecord.get( 2 ) )
        #set( $void                  = $chanwGetAssetInfoById.add( $chanwAssetSiteName ) )
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetBlockOrphanIdCachepathBySiteName( $siteName )《/code》
《p》Returns a list containing ids and paths of block orphans in the site.《/p》
《pre》
#set( $siteName = "cascade-admin" )
#chanwGetBlockOrphanIdCachepathBySiteName( $siteName )
$chanwGetBlockOrphanIdCachepathBySiteName
《/pre》
《/documentation》
《macro id=“chanwGetBlockOrphanIdCachepathBySiteName”》
doc*###
#macro( chanwGetBlockOrphanIdCachepathBySiteName $chanwGetBlockOrphanIdCachepathBySiteNameSiteName )
    #chanwGetIdCachepathBySqlSiteName( $sqlBlockOrphan $chanwGetBlockOrphanIdCachepathBySiteNameSiteName )
    #set( $chanwGetBlockOrphanIdCachepathBySiteName = $chanwGetIdCachepathBySqlSiteName )
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetColumnLabelsFromRS( $rs_chanwGetColumnLabelsFromRS )《/code》
《p》Returns a list of labels from the result set.《/p》
《pre》
#chanwGetColumnLabelsFromRS( $rs )
$chanwGetColumnLabelsFromRS
《/pre》
《/documentation》
《macro id=“chanwGetColumnLabelsFromRS”》
doc*###
#macro( chanwGetColumnLabelsFromRS $rs_chanwGetColumnLabelsFromRS )
    #set( $chanwRSMetadata = $chanwGetResultSet.MetaData )
    #set( $chanwRSMetadataColCount = $chanwRSMetadata.ColumnCount )
    #set( $chanwGetColumnLabelsFromRS = [] )
##
    #foreach( $count in [ 1..$chanwRSMetadataColCount ] )
        #set( $dummy = $chanwGetColumnLabelsFromRS.add( $chanwRSMetadata.getColumnLabel( $count ) ) )
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetDatabaseList( $listName $sql )《/code》
《p》Creates a global variable out of the name 《code》$listName《/code》, and associates
the global variable with a list of values drawn from the database. The SQL string
associated with 《code》$sql《/code》 should be an SQL statement selecting a single value
from a table. Example:《/p》
《pre》
#chanwGetDatabaseList( "upstateSiteName" "select name from cxml_site" )
《/pre》
《/documentation》
《macro id=“chanwGetDatabaseList”》
doc*###
#macro( chanwGetDatabaseList $chanwGetDatabaseListListName $chanwGetDatabaseListSql )
    #chanwCheckString( $chanwGetDatabaseListListName "A name for a global variable is required" )
    #chanwGetResultSet( $chanwGetDatabaseListSql )
    #set( $chanwData = $chanwGetResultSet )
    #set( $chanwStmt = '#set($' + $chanwGetDatabaseListListName + '=[])' )
    #evaluate( $chanwStmt )
##
    #if( $chanwData.next() )
        ## the first record
        #set( $void = $chanwData.first() )
        #set( $chanwStmt = '#set($void=$' + $chanwGetDatabaseListListName +
            '.add($chanwData.getString( 1 ) ) )' )
        #evaluate( $chanwStmt )
##
        ## loop through all other records
        #foreach( $num in [ 1..$INTEGER_MAX_VALUE ] )
            #if( $chanwData.next() )
                #set( $chanwStmt = '#set($void=$' + $chanwGetDatabaseListListName +
                    '.add( $chanwData.getString( 1 ) ) )' )
                #evaluate( $chanwStmt )
            #else
                #break
            #end
        #end
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetDatabaseStatement《/code》
《p》Creates a 《code》DatabaseMetaData《/code》 object named 《code》$chanwMetaData《/code》
and a 《code》Statement《/code》 object named 《code》$chanwGetDatabaseStatement《/code》
associated with the Cascade database. This macro is used by other macros.《/p》
《/documentation》
《macro id=“chanwGetDatabaseStatement”》
doc*###
#macro( chanwGetDatabaseStatement )
    #set( $chanwGetDatabasStatement = "" )
    #chanwGetObjectByClassName( "javax.naming.InitialContext" )
    #set( $chanwContext    = $chanwGetObjectByClassName )
    #set( $chanwDataSource = $chanwContext.lookup( "java:comp/env/jdbc/CascadeDS" ) )
    #set( $chanwConnection = $chanwDataSource.Connection )
    $chanwConnection.setReadOnly( true )
    #set( $chanwMetaData   = $chanwConnection.MetaData )
    #set( $chanwGetDatabaseStatement = $chanwConnection.createStatement( 
        $_FieldTool.in( "java.sql.ResultSet" ).TYPE_SCROLL_INSENSITIVE, 
        $_FieldTool.in( "java.sql.ResultSet" ).CONCUR_READ_ONLY ) )
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetFileOrphanIdCachepathBySiteName( $siteName )《/code》
《p》Returns a list containing ids and paths of file orphans in the site.《/p》
《pre》
#set( $siteName = "cascade-admin" )
#chanwGetFileOrphanIdCachepathBySiteName( $siteName )
$chanwGetFileOrphanIdCachepathBySiteName
《/pre》
《/documentation》
《macro id=“chanwGetFileOrphanIdCachepathBySiteName”》
doc*###
#macro( chanwGetFileOrphanIdCachepathBySiteName $chanwGetFileOrphanIdCachepathBySiteNameSiteName )
    ##set( $chanwSql = $sqlFileOrphan.replaceAll( '-siteName-', $chanwGetFileOrphanIdCachepathBySiteNameSiteName ) )
    ##chanwGetResultSet( $chanwSql )
    ##chanwGetRecordListFromResultSet( $chanwGetResultSet false )
    #chanwGetIdCachepathBySqlSiteName( $sqlFileOrphan $chanwGetFileOrphanIdCachepathBySiteNameSiteName )
    #set( $chanwGetFileOrphanIdCachepathBySiteName = $chanwGetRecordListFromResultSet )
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetHTMLTableFromResultSet( $rs )《/code》
《p》Creates an XHTML table out of the result set. The resulting table is stored
in 《code》$globalStringBuffer《/code》. This macro is used by
《code》#chanwGetHTMLTableFromSql《/code》.《/p》
《pre》
#chanwGetResultSet( "SELECT count(*) Count FROM CXML_ASSETFACTORY" )
#chanwGetHTMLTableFromResultSet( $chanwGetResultSet )
$globalStringBuffer.toString()
《/pre》
《/documentation》
《macro id=“chanwGetHTMLTableFromResultSet”》
doc*###
#macro( chanwGetHTMLTableFromResultSet $chanwGetHTMLTableFromResultSetRs )
    #chanwGetRecordListFromResultSet( $chanwGetHTMLTableFromResultSetRs )
    $globalStringBuffer.setLength( 0 )
##
    #if( $chanwGetRecordListFromResultSet.size() == 0 )
        Empty result set
    #else
        #set( $chanwRecordListFromResultSetLastIndex = $chanwGetRecordListFromResultSet.size() - 1 )
        #chanwGetColumnLabelsFromRS( $chanwGetHTMLTableFromResultSetRs )
        #set( $chanwLastColumnIndex = $chanwGetColumnLabelsFromRS.size() - 1 )
##
        #set( $void = $globalStringBuffer.append(
            "<table class='tcellspacing1 tcellpadding5' summary='Table'>" ) )
        #set( $void = $globalStringBuffer.append(
            "<tr class='bg1 text_white'>" ) )
##
        #foreach( $label in $chanwGetColumnLabelsFromRS )
            #set( $void = $globalStringBuffer.append( "<th>$label</th>" ) )
        #end
##
        #set( $void = $globalStringBuffer.append( "</tr>" ) )
##
        #foreach( $counter in [ 0..$chanwRecordListFromResultSetLastIndex ] )
            #set( $chanwRecordList = $chanwGetRecordListFromResultSet.get( $counter ) )
##
            #if( $counter % 2 == 0 )
                #set( $void = $globalStringBuffer.append( "<tr>" ) )
            #else
                #set( $void = $globalStringBuffer.append(
                    "<tr class='tablerow1'>" ) )
            #end
##
            #foreach( $col in [ 0..$chanwLastColumnIndex ] )
                #set( $void = $globalStringBuffer.append( "<td>" ) )
                #set( $void = $globalStringBuffer.append( $chanwRecordList.get( $col ) ) )
                #set( $void = $globalStringBuffer.append( "</td>" ) )
            #end
##
            #set( $void = $globalStringBuffer.append( "</tr>" ) )
        #end
##
        #set( $void = $globalStringBuffer.append( "</table>" ) )
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetHTMLTableFromSql( $sql )《/code》
《p》Creates an XHTML table out of the result set associated with the SQL statement.
The resulting table is stored in 《code》$chanwGetHTMLTableFromSql《/code》. Example:《/p》
《pre》
#set( $sql = "SELECT tablespace_name, table_name FROM all_tables " +
             "WHERE tablespace_name LIKE 'C%' " +
             "AND table_name like 'CXML_%' " +
             "ORDER BY table_name" )
#chanwGetHTMLTableFromSql( $sql )
$chanwGetHTMLTableFromSql
《/pre》
《/documentation》
《macro id=“chanwGetHTMLTableFromSql”》
doc*###
#macro( chanwGetHTMLTableFromSql $chanwGetHTMLTableFromSqlSql )
    #if( !$chanwGetDatabasStatement )
        #chanwGetDatabaseStatement()
        #chanwCheckStatement( $chanwGetDatabaseStatement )
    #end
##
    #chanwCheckString( $chanwGetHTMLTableFromSqlSql "An SQL string is required." )
    #chanwGetResultSet( $chanwGetHTMLTableFromSqlSql )
##
    #if( $chanwGetResultSet != "" )
        #chanwGetHTMLTableFromResultSet( $chanwGetResultSet )
    #end
##
    #set( $chanwGetHTMLTableFromSql = $globalStringBuffer.toString() )
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetIdCachepathBySqlSiteName( $sql $siteName )《/code》
《p》Returns a list of id strings and cache paths of assets using the supplied
SQL and site name. This macro is used by other marcros. Example:《/p》
《pre》
#chanwGetIdCachepathBySqlSiteName( $sqlCachepathWithSpace $siteName )
《/pre》
《/documentation》
《macro id=“chanwGetIdCachepathBySqlSiteName”》
doc*###
#macro( chanwGetIdCachepathBySqlSiteName $chanwGetIdCachepathBySqlSiteNameSql $chanwGetIdCachepathBySqlSiteNameSiteName )
    #set( $chanwGetIdCachepathBySqlSiteName = "" )
    #set( $chanwSql = $chanwGetIdCachepathBySqlSiteNameSql.replaceAll( '-siteName-', $chanwGetIdCachepathBySqlSiteNameSiteName ) )
    #chanwGetResultSet( $chanwSql )
    #chanwGetRecordListFromResultSet( $chanwGetResultSet false )
    #set( $chanwGetIdCachepathBySqlSiteName = $chanwGetRecordListFromResultSet )
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetIdCachepathWithSpaceBySiteName( $siteName )《/code》
《p》Returns a list of id strings and cache paths of assets whose system names
contain space characters. Example:《/p》
《pre》
#chanwGetIdCachepathWithSpaceBySiteName( "cascade-admin" )
$chanwGetIdCachepathWithSpaceBySiteName
《/pre》
《/documentation》
《macro id=“chanwGetIdCachepathWithSpaceBySiteName”》
doc*###
#macro( chanwGetIdCachepathWithSpaceBySiteName $chanwGetIdCachepathWithSpaceBySiteNameSiteName )
    #chanwGetIdCachepathBySqlSiteName( $sqlCachepathWithSpace $chanwGetIdCachepathWithSpaceBySiteNameSiteName )
    #set( $chanwGetIdCachepathWithSpaceBySiteName = $chanwGetIdCachepathBySqlSiteName )
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetIdCachepathWithUppercaseCharBySiteName( $siteName )《/code》
《p》Returns a list of id strings and cache paths of assets whose system names
contain uppercase characters. Example:《/p》
《pre》
#chanwGetIdCachepathWithUppercaseCharBySiteName( "cascade-admin" )
$chanwGetIdCachepathWithUppercaseCharBySiteName
《/pre》
《/documentation》
《macro id=“chanwGetIdCachepathWithUppercaseCharBySiteName”》
doc*###
#macro( chanwGetIdCachepathWithUppercaseCharBySiteName $chanwGetIdCachepathWithUppercaseCharBySiteNameSiteName )
    #chanwGetIdCachepathBySqlSiteName( $sqlCachepathWithUppercaseChar $chanwGetIdCachepathWithUppercaseCharBySiteNameSiteName )
    #set( $chanwGetIdCachepathWithUppercaseCharBySiteName = $chanwGetIdCachepathBySqlSiteName )
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetIndexableChildrenIdTypeMap( $folder )《/code》
《p》Returns a map, containing information of indexable children of a folder.
The folder must be a Cascade API object. The keys of the map are id strings of
these children, and the values are the types of the children.
Example:《/p》
《pre》
#set( $folder = $currentPage.ParentFolder )
#chanwGetIndexableChildrenIdTypeMap( $folder )
$chanwGetIndexableChildrenIdTypeMap
《/pre》
《/documentation》
《macro id=“chanwGetIndexableChildrenIdTypeMap”》
doc*###
#macro( chanwGetIndexableChildrenIdTypeMap $chanwGetIndexableChildrenIdTypeMapFolder )
    #chanwGetAssetId( $chanwGetIndexableChildrenIdTypeMapFolder )
    #set( $chanwFolderId = $chanwGetAssetId )
    #set( $chanwSql = 
        "select id, assettype from cxml_foldercontent where parentfolderid='$chanwGetAssetId' " +
        "and shouldbeindexed=1 and iscurrentversion=1" )
    #chanwGetResultSet( $chanwSql )
##
    #set( $chanwGetIndexableChildrenIdTypeMap = {} )
##
    #if( $chanwGetResultSet.next() )
        $chanwGetResultSet.beforeFirst()
##
        #foreach( $count in [ 1..$INTEGER_MAX_VALUE ] )
            #if( $chanwGetResultSet.next() )
                #set( $dummy = $chanwGetIndexableChildrenIdTypeMap.put(
                    $chanwGetResultSet.getString( 1 ), $chanwGetResultSet.getString( 2 ) ) )
            #else
                #break
            #end
        #end
        ## move cursor back to the front
        $chanwGetResultSet.beforeFirst()
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetMetaDataRS( $table )《/code》
《p》Creates a 《code》ResultSet《/code》 object named 《code》$chanwGetMetaDataRS《/code》
associated with the Cascade database. This macro is used by other macros.《/p》
《p》Using the 《code》$chanwGetMetaDataRS《/code》 object:《/p》
《pre》
#set( $metaData = $chanwGetMetaDataRS.MetaData )

#foreach( $col in [ 1..$columnCount ] )
    $metaData.getColumnLabel( $col )
#end
《/pre》
《p》This outputs:《/p》
《pre》
    TABLE_CAT
    TABLE_SCHEM
    TABLE_NAME
    COLUMN_NAME
    DATA_TYPE
    TYPE_NAME
    COLUMN_SIZE
    BUFFER_LENGTH
    DECIMAL_DIGITS
    NUM_PREC_RADIX
    NULLABLE
    REMARKS
    COLUMN_DEF
    SQL_DATA_TYPE
    SQL_DATETIME_SUB
    CHAR_OCTET_LENGTH
    ORDINAL_POSITION
    IS_NULLABLE
    SCOPE_CATALOG
    SCOPE_SCHEMA
    SCOPE_TABLE
    SOURCE_DATA_TYPE
    IS_AUTOINCREMENT
《/pre》
《p》These column labels can be used to retrieve values from 《code》$chanwGetMetaDataRS《/code》.
See 《code》#chanwGetTableColumnNames《/code》 for example.《/p》
《/documentation》
《macro id=“chanwGetMetaDataRS”》
doc*###
#macro( chanwGetMetaDataRS $chanwGetMetaDataRSTable )
    #if( !$chanwMetaData )
        Invoke chanwGetDatabaseStatement first.
        #stop
    #end
##
    #set( $chanwGetMetaDataRS = $chanwMetaData.getColumns( null, null, $chanwGetMetaDataRSTable, "%" ) )
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetNumberOfRecordsInResultSet( $rs )《/code》
《p》Returns the number of records in the result set. The returned value is stored in 
the global variable 《code》$chanwGetNumberOfRecordsInResultSet《/code》. Example:《/p》
《pre》
#set( $sql  = "SELECT userName, email, fullName FROM cxml_user" )
#chanwGetResultSet( $sql )
#chanwGetNumberOfRecordsInResultSet( $chanwGetResultSet )
$chanwGetNumberOfRecordsInResultSet
《/pre》
《/documentation》
《macro id=“chanwGetNumberOfRecordsInResultSet”》
doc*###
#macro( chanwGetNumberOfRecordsInResultSet $chanwGetNumberOfRecordsInResultSetRs )
    #chanwCheckResultSet( $chanwGetNumberOfRecordsInResultSetRs )
    #set( $chanwGetNumberOfRecordsInResultSet = 0 )
##
    #if( $chanwGetNumberOfRecordsInResultSetRs.next() )
        #set( $void = $chanwGetNumberOfRecordsInResultSetRs.last() )
        #set( $chanwGetNumberOfRecordsInResultSet = $chanwGetNumberOfRecordsInResultSetRs.getRow() )
        ## move cursor back to the front
        $chanwGetNumberOfRecordsInResultSetRs.beforeFirst()
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetNumberOfRecordsInTable( $table )《/code》
《p》Returns the number of records in the table. The returned value is stored in 
the global variable 《code》$chanwGetNumberOfRecordsInTable《/code》. Example:《/p》
《pre》
#chanwGetNumberOfRecordsInTable( "cxml_aclentry" )
$chanwGetNumberOfRecordsInTable
《/pre》
《/documentation》
《macro id=“chanwGetNumberOfRecordsInTable”》
doc*###
#macro( chanwGetNumberOfRecordsInTable $chanwGetNumberOfRecordsInTableTable )
    #if( !$chanwGetDatabasStatement )
        #chanwGetDatabaseStatement()
        #chanwCheckStatement( $chanwGetDatabaseStatement )
    #end
##
    #chanwCheckString( $chanwGetNumberOfRecordsInTableTable "A table name is required." )
##
    #set( $chanwSql       = "SELECT count(*) FROM $chanwGetNumberOfRecordsInTableTable " )
    #set( $chanwResultSet = $chanwGetDatabaseStatement.executeQuery( $chanwSql ) )
##
    #if( $chanwResultSet.next() )
        #set( $chanwGetNumberOfRecordsInTable = $globalApacheMathTool.toNumber( $chanwResultSet.getString( 1 ) ) )
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetRecordListFromResultSet( $rs )《/code》
《p》Returns a list of lists, containing values of the result set. The outer
list stores lists representing rows, and each inner list stores values of a row.
When a true is passed in as the second parameter, the first inner list stores
metadata (column names or aliases) of the result set. The second parameter is
defaulted to false. Example:《/p》
《pre》
#chanwGetResultSet( "SELECT count(*) Count FROM CXML_ASSETFACTORY" )
#chanwGetRecordListFromResultSet( $chanwGetResultSet )
$chanwGetRecordListFromResultSet
《/pre》
《/documentation》
《macro id=“chanwGetRecordListFromResultSet”》
doc*###
#macro( chanwGetRecordListFromResultSet $chanwGetRecordListFromResultSetRs $chanwGetRecordListFromResultSetWithColNames )
    #chanwCheckResultSet( $chanwGetRecordListFromResultSetRs )
##
    #if( $chanwGetRecordListFromResultSetWithColNames.Class.name && $chanwGetRecordListFromResultSetWithColNames == true )
        #set( $chanwWithColNames = true ) 
    #else
        #set( $chanwWithColNames = false ) ## defaulted to false
    #end
##
    #set( $chanwResultSetMetadata    = $chanwGetRecordListFromResultSetRs.MetaData )
    #set( $chanwResultSetColumnCount = $chanwResultSetMetadata.ColumnCount )
    #set( $chanwGetRecordListFromResultSet = [] )
##
    ## store metadata
    #set( $chanwRecordList = [] )
##
    #if( $chanwWithColNames )
        #foreach( $col in [ 1..$chanwResultSetColumnCount ] )
            #set( $void = $chanwRecordList.add(
                $chanwResultSetMetadata.getColumnName( $col ) ) )
        #end
        #set( $void = $chanwGetRecordListFromResultSet.add( $chanwRecordList ) )
    #end
##
    #set( $chanwNumberOfRecords = 0 )
    $chanwGetRecordListFromResultSetRs.beforeFirst()
##
    #foreach( $counter in [ 1..$INTEGER_MAX_VALUE ] )
        #if( $chanwGetRecordListFromResultSetRs.next() )
        	#set( $chanwRecordList = [] )
            #set( $chanwNumberOfRecords = $chanwNumberOfRecords + 1 )
                
            #foreach( $col in [ 1..$chanwResultSetColumnCount ] )
                #set( $void = $chanwRecordList.add(
                    $chanwGetRecordListFromResultSetRs.getString( $col ) ) )
            #end
##
            #set( $void = $chanwGetRecordListFromResultSet.add( $chanwRecordList ) )
        #else
            #break
        #end
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetRecordListFromSql( $sql )《/code》
《p》Returns a list of lists, containing values of the result set. The outer
list stores lists representing rows, and each inner list stores values of a row. Example:《/p》
《pre》
#chanwGetRecordListFromSql( "SELECT * FROM CXML_ASSETFACTORY" )
《/pre》
《/documentation》
《macro id=“chanwGetRecordListFromSql”》
doc*###
#macro( chanwGetRecordListFromSql $sql_chanwGetRecordListFromSql )
    #chanwGetResultSet( $sql_chanwGetRecordListFromSql )
    #chanwGetRecordListFromResultSet( $chanwGetResultSet )
    #set( $chanwGetRecordListFromSql = $chanwGetRecordListFromResultSet )
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetResultSet( $sql )《/code》
《p》Returns the result set associated with the SQL statement. The result set is stored in
《code》$chanwGetResultSet《/code》. Example:《/p》
《pre》
#chanwGetResultSet( "SELECT count(*) FROM CXML_ASSETFACTORY" )
《/pre》
《/documentation》
《macro id=“chanwGetResultSet”》
doc*###
#macro( chanwGetResultSet $chanwGetResultSetSql )
    #if( !$chanwGetDatabasStatement )
        #chanwGetDatabaseStatement()
        #chanwCheckStatement( $chanwGetDatabaseStatement )
    #end
##
    #chanwCheckString( $chanwGetResultSetSql "An SQL string is required." )
##
    #set( $chanwGetResultSet = "" )
    #set( $chanwGetResultSet = $chanwGetDatabaseStatement.executeQuery( $chanwGetResultSetSql ) )
##
    #if( !$chanwGetResultSet )
        No result set returned
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetSingleValue( $sql )《/code》
《p》Returns a single value. The result set is stored in
《code》$chanwGetSingleValue《/code》. Example:《/p》
《pre》
#chanwGetSingleValue( "SELECT count(*) FROM CXML_ASSETFACTORY" )
《/pre》
《/documentation》
《macro id=“chanwGetSingleValue”》
doc*###
#macro( chanwGetSingleValue $sql_chanwGetSingleValue )
    #set( $chanwGetSingleValue = "" )
    #chanwGetResultSet( $sql_chanwGetSingleValue )
##
    #if( $chanwGetResultSet.next() )
        #set( $chanwGetSingleValue = $chanwGetResultSet.getString( 1 ) )
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetSiteIdBySiteName( $siteName )《/code》
《p》Returns the site id of the site so named.《/p》
《pre》
#chanwGetSiteIdBySiteName( "22q" )
$chanwGetSiteIdBySiteName
《/pre》
《/documentation》
《macro id=“chanwGetSiteIdBySiteName”》
doc*###
#macro( chanwGetSiteIdBySiteName $chanwGetSiteIdBySiteNameSiteName )
    #set( $chanwGetSiteIdBySiteName = "" )
    #set( $chanwSql = "select id from cxml_site where name='$chanwGetSiteIdBySiteNameSiteName'" )
    #chanwGetResultSet( $chanwSql )
##
    #if( $chanwGetResultSet.next() )
        #set( $chanwGetSiteIdBySiteName = $chanwGetResultSet.getString( 1 ) )
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetSiteNameBySiteId( $siteName )《/code》
《p》Returns the site id of the site so named.《/p》
《pre》
#chanwGetSiteNameBySiteId( "b4d831e88b7f085601ed95543b747ed6" )
$chanwGetSiteNameBySiteId
《/pre》
《/documentation》
《macro id=“chanwGetSiteNameBySiteId”》
doc*###
#macro( chanwGetSiteNameBySiteId $chanwGetSiteNameBySiteIdSiteId )
    #set( $chanwGetSiteNameBySiteId = "" )
    #set( $chanwSql = "select name from cxml_site where id='$chanwGetSiteNameBySiteIdSiteId'" )
    #chanwGetResultSet( $chanwSql )
##
    #if( $chanwGetResultSet.next() )
        #set( $chanwGetSiteNameBySiteId = $chanwGetResultSet.getString( 1 ) )
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetTableColumnNames( $table )《/code》
《p》Returns a list of column names of the table. Note that the table name must
in lowercase like "cxml_site" for MySql.《/p》
《pre》
#chanwGetTableColumnNames( "cxml_site" )
$chanwGetTableColumnNames
《/pre》
《/documentation》
《macro id=“chanwGetTableColumnNames”》
doc*###
#macro( chanwGetTableColumnNames $chanwGetTableColumnNamesTable )
    #chanwGetDatabaseStatement
    #chanwGetMetaDataRS( $chanwGetTableColumnNamesTable )
    #set( $chanwGetTableColumnNames = [] )
##
    ## Oracle
    #if( $chanwOracleDB )
        #set( $chanwSql = "select * from $chanwGetTableColumnNamesTable where 1 = 0" )
        #chanwGetResultSet( $chanwSql )
        #set( $chanwResultSetMetadata = $chanwGetResultSet.getMetaData() )
        #set( $chanwResultSetMetadataColumnCount = $chanwResultSetMetadata.getColumnCount() )
##
        #foreach( $num in [ 1..$chanwResultSetMetadataColumnCount ] )
            #set( $chanwColumnName = '"' + $chanwResultSetMetadata.getColumnLabel( $num ).toLowerCase() + '"' )
            #set( $void = $chanwGetTableColumnNames.add( $chanwColumnName ) )
        #end
    ## MySql
    #else
        #foreach( $row in [ 1..500 ] )
            #if( $chanwGetMetaDataRS.next() )
                #set( $chanwColumnName = '"' + $chanwGetMetaDataRS.getString( "COLUMN_NAME" ).toLowerCase() + '"' )
                #set( $void = $chanwGetTableColumnNames.add( $chanwColumnName ) )
            #else
                #break
            #end
        #end
    #end
#end
#*doc
《/macro》
《documentation》
《code》#chanwGetUserCountAuditByActionDays( $action $days )《/code》
《p》Returns a list of usernames and counts from the audit table.
Acceptable actions are:《/p》
《pre》
activate_version
advance_workflow
assume_identity
copy
create
delete
edit
identity_assumed
identity_unassumed
login
login_failed
logout
move
publish
recycle
reference
start_workflow
startedit
unassume_identity
unpublish
《/pre》
《p》The 《code》$days《/code》 variable should store a negative integer.《/p》
《pre》
#chanwGetUserCountAuditByActionDays( "login_failed" -5 )
$chanwGetUserCountAuditByActionDays
《/pre》
《/documentation》
《macro id=“chanwGetUserCountAuditByActionDays”》
doc*###
#macro( chanwGetUserCountAuditByActionDays $chanwGetUserCountAuditByActionDaysAction $chanwGetUserCountAuditByActionDaysDays )
    #set( $chanwGetUserCountAuditByActionDays = [] )
    ## find the timestamp for comparison
    #set( $chanwPastCalendarObject = $chanwCalendarObject.clone() )
    $chanwPastCalendarObject.add( $chanwDayField, $chanwGetUserCountAuditByActionDaysDays )
    #set( $chanwPastDateObject = $_DateTool.toDate( $chanwPastCalendarObject ) )
    #set( $chanwPastTimestamp = $chanwPastDateObject.getTime() )
    #set( $chanwSql = "select username, count(username) from cxml_audit " +
        "where action='$chanwGetUserCountAuditByActionDaysAction' and tstamp>$chanwPastTimestamp group by username" )
    #chanwGetResultSet( $chanwSql )
    #chanwGetRecordListFromResultSet( $chanwGetResultSet )
    #set( $chanwGetUserCountAuditByActionDays = $chanwGetRecordListFromResultSet )
#end
#*doc
《/macro》
《documentation id=“bottom”》
《/documentation》
《/code》
doc*###