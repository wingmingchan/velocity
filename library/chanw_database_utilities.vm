#*
《code》
《copyright》
Author: Wing Ming Chan
Copyright (c) 2017 Wing Ming Chan <chanw@upstate.edu>
MIT Licensed
Modification history:
1/12/2017 Added more code for Oracle
1/9/2017 Added #chanwGetAllTableNames
《/copyright》
《documentation id=“top”》
《h2》Introduction《/h2》
《p》This format defines utility macros to access the Cascade database. At the end
of the format using this library format, put in 《code》#chanwCleanUp《/code》
as the last line of the code.《/p》
《p class=“text_red”》Important: table names used in SQL statement are case-sensitive.
Use uppercase for Oracle, and lowercase for MySQL.《/p》
《/documentation》
*#
#import( 'formats/library/velocity/chanw_global_macros' )
#*
《global-variables》
*#
#set( $chanwDatabaseUtilitiesGlobalVariables = [ 
    "chanwColumnCount",
    "chanwConnection",
    "chanwContext",
    "chanwData",
    "chanwDataSource",
    "chanwDBMetadata",
    "chanwDBMetadataRS",
    "chanwGetAllTableNames",
    "chanwGetDatabasStatement",
    "chanwGetHTMLTableFromSql",
    "chanwLastRecordNumber",
    "chanwGetMetaDataRS",
    "chanwGetNumberOfRecordsInResultSet",
    "chanwGetNumberOfRecordsInTable",
    "chanwGetResultSet",
    "chanwGetTableColumnNames",
    "chanwMetaData",
    "chanwResultSet",
    "chanwResultSetMetadata",
    "chanwResultSetColumnCount",
    "chanwSql"
] )
#*
《/global-variables》
《documentation》
《code》#chanwCheckResultSet( $rs )《/code》
《p》Checks the variable 《code》$rs《/code》 to make sure that it is associated
with a valid result set. This macro is used by other macros.《/p》
《/documentation》
《macro id=“chanwCheckResultSet”》
*#
#macro( chanwCheckResultSet $rs )
    #chanwIsInstanceOf( $rs $JAVA_SQL_RESULT_SET_CLASS_NAME )
    
    #if( !$chanwIsInstanceOf )
    A ResultSet object is required.
    #stop
    #end
#end
#*
《/macro》
《documentation》
《code》#chanwCheckStatement( $stmt )《/code》
《p》Checks the variable 《code》$stmt《/code》 to make sure that it is associated
with a valid statement. This macro is used by other macros.《/p》
《/documentation》
《macro id=“chanwCheckStatement”》
*#
#macro( chanwCheckStatement $stmt )
    #chanwIsInstanceOf( $stmt $JAVA_SQL_STATEMENT_CLASS_NAME )
    
    #if( !$chanwIsInstanceOf )
    A Statement object is required.
    #stop
    #end
#end
#*
《/macro》
《documentation》
《code》#chanwCleanUp《/code》
《p》Cleans up the connection and statement objects. Note that once this macro
is invoked, the connection to the database is closed. To open the connecton again,
invoke 《code》#chanwGetDatabaseStatement《/code》 like this:《/p》
《pre》
#if( !$chanwConnection || $chanwConnection.isClosed() )
    #chanwGetDatabaseStatement
#end
《/pre》
《/documentation》
《macro id=“chanwCleanUp”》
*#
#macro( chanwCleanUp )
    #if( $chanwConnection )
        ##still open
        $chanwConnection.close()
    #end
    
    #if( $chanwGetDatabaseStatement )
        $chanwGetDatabaseStatement.close()
    #end
#end
#*
《/macro》
《documentation》
《code》#chanwCreateDatabasePHPCode( $data )《/code》
《p》Creates PHP code containing a variable named 《code》$view《/code》,
pointing to an array of values drawn from the result set 《code》$data《/code》.
The first column of the view must be keys, and the view must have at least two
columns. The resulting code is stored in 《code》$globalStringBuffer《/code》.
To build a one-column list, use 《code》#chanwGetDatabaseList《/code》 instead.
Example:《/p》
《pre》
#import( 'site://_common_assets/formats/library/velocity/chanw_library_import' )

#set( $sql  = "SELECT userName, email, fullName FROM cxml_user" )
#chanwGetResultSet( $sql )
#chanwCreateDatabasePHPCode( $chanwGetResultSet )
$globalStringBuffer.toString()
《/pre》
《p》The PHP code generated will be something like:《/p》
《pre》
$view=array(
"wing"=&gt; array("wing@upstate.edu","Wing"),);
《/pre》
《p》To use the PHP code, publish the code in an XML page, then read the page
contents using the page URL. Once the code is read, replace all instances of
《code》&gt;《/code》 with 《code》<《/code》, and then evaluate the code.
The variable 《code》$view《/code》 will be associated with an associative array,
with usernames as keys and emails and full names as values.《/p》
《/documentation》
《macro id=“chanwCreateDatabasePHPCode”》
*#
#macro( chanwCreateDatabasePHPCode $data )
    #chanwCheckResultSet( $data )
    
    #if( $data.last() )
        #set( $chanwLastRecordNumber = $data.Row )
    #end

    #set( $chanwColumnCount = $data.getMetaData().getColumnCount() )
    $globalStringBuffer.setLength( 0 )
    #set( $void = $globalStringBuffer.append( '$view=array(' ) )
    
    #if( $chanwLastRecordNumber > 0 )
        #set( $void = $data.first() )
        ## the code is formatted in this way to avoid too much space within 
        ## foreach to avoid hanging
        ## the first record
        #foreach( $count in [ 1..$chanwColumnCount ] )##
            #if( $count == 1 )#set(
                $void = $globalStringBuffer.append( '"' ).append( $data.getString(##
                $count ) ).append( '"=>array(' ) )##
            #else#set( $void = $globalStringBuffer.append( '"' ).append(##
                $data.getString( $count ) ).append( '"' ) )##
                #if( $count == $chanwColumnCount )#set( $void = $globalStringBuffer.append( ")," ) )##
                #else#set( $void = $globalStringBuffer.append( "," ) )##
                #end##
            #end##
        #end##
        
        ## loop through all remaining records
#foreach( $i in [ 2..$chanwLastRecordNumber ] )##
#set( $void = $data.next() )##
#foreach( $j in [ 1..$chanwColumnCount ] )##
#if( $j == 1 )#set( $void = $globalStringBuffer.append( '"' ).append(##
$data.getString( $j ) ).append( '"=>array(' ) )##
#else##
#set( $void = $globalStringBuffer.append( '"' ).append(##
$data.getString( $j ) ).append( '"' ) )##
#if( $j == $chanwColumnCount )##
#set( $void = $globalStringBuffer.append( ")," ) )##
#else##
#set( $void = $globalStringBuffer.append( "," ) )##
#end##
#end##
#end##
#end##
#end##
    
    #set( $void = $globalStringBuffer.append( ");" ) )
#end
#*
《/macro》
《documentation》
《code》#chanwGetAllTableNames《/code》
《p》Creates a global variable named 《code》$chanwGetAllTableNames《/code》, which
stores all table names. Example:《/p》
《pre》
#chanwGetAllTableNames
$chanwGetAllTableNames
《/pre》
《/documentation》
《macro id=“chanwGetAllTableNames”》
*#
#macro( chanwGetAllTableNames )
    #if( !$chanwConnection || $chanwConnection.isClosed() )
        #chanwGetDatabaseStatement
    #end
    
    ## MySQL
    #set( $chanwDBMetadata    = $chanwConnection.getMetaData() )
    #set( $chanwDBMetadataRS  = $chanwDBMetadata.getTables( null, null, "%", null ) )
    #set( $chanwGetAllTableNames = [] )

    #if( $chanwDBMetadataRS.next() )
        #if( $chanwDBMetadataRS.getString( 3 ).startsWith( "cxml_" ) )
            #set( $chanwTableName = '"' + $chanwDBMetadataRS.getString( 3 ).toLowerCase() + '"' )
            #set( $void = $chanwGetAllTableNames.add( $chanwTableName ) )
        #end
        
        #foreach( $num in [ 1..500 ] )
            #if( $chanwDBMetadataRS.next() )
                #if( $chanwDBMetadataRS.getString( 3 ).startsWith( "cxml_" ) )
                    #set( $chanwTableName = '"' + $chanwDBMetadataRS.getString( 3 ).toLowerCase() + '"' )
                    #set( $void = $chanwGetAllTableNames.add( $chanwTableName ) )
                #end
            #else
                #break
            #end
        #end
    #end
   
    ## Oracle
    #if( $chanwGetAllTableNames.size() == 0 )
        #set( $chanwSql = "SELECT tablespace_name, table_name FROM all_tables " +
             "WHERE tablespace_name LIKE 'C%' " +
             "AND table_name like 'CXML_%' " +
             "ORDER BY table_name" )
        
        #chanwGetResultSet( $chanwSql )

        #if( $chanwGetResultSet.next() )
            #set( $chanwTableName = '"' + $chanwGetResultSet.getString( 2 ).toLowerCase() + '"' )
            #set( $void = $chanwGetAllTableNames.add( $chanwTableName ) )
        
            #foreach( $num in [ 1..500 ] )
                #if( $chanwGetResultSet.next() )
                    #set( $chanwTableName = '"' + $chanwGetResultSet.getString( 2 ).toLowerCase() + '"' )
                    #set( $void = $chanwGetAllTableNames.add( $chanwTableName ) )
                #else
                    #break
                #end
            #end
        #end
    #end
#end
#*
《/macro》
《documentation》
《code》#chanwGetDatabaseList( $listName $sql )《/code》
《p》Creates a global variable out of the name 《code》$listName《/code》, and associates
the global variable with a list of values drawn from the database. The SQL string
associated with 《code》$sql《/code》 should be an SQL statement selecting a single value
from a table. Example:《/p》
《pre》
#chanwGetDatabaseList( "upstateSiteName" "select name from cxml_site" )
《/pre》
《/documentation》
《macro id=“chanwGetDatabaseList”》
*#
#macro( chanwGetDatabaseList $listName $sql )
    #chanwCheckString( $listName "A name for a global variable is required" )
    #chanwGetResultSet( $sql )
    #set( $chanwData = $chanwGetResultSet )
    #set( $chanwStmt = '#set($' + $listName + '=[])' )
    #evaluate( $chanwStmt )

    #if( $chanwData.next() )
        ## the first record
        #set( $void = $chanwData.first() )
        #set( $chanwStmt = '#set($void=$' + $listName +
            '.add($chanwData.getString( 1 ) ) )' )
        #evaluate( $chanwStmt )
    
        ## loop through all other records
        #foreach( $num in [ 1..$INTEGER_MAX_VALUE ] )
            #if( $chanwData.next() )
                #set( $chanwStmt = '#set($void=$' + $listName +
                    '.add( $chanwData.getString( 1 ) ) )' )
                #evaluate( $chanwStmt )
            #else
                #break
            #end
        #end
    #end
#end
#*
《/macro》
《documentation》
《code》#chanwGetDatabaseStatement《/code》
《p》Creates a 《code》DatabaseMetaData《/code》 object named 《code》$chanwMetaData《/code》
and a 《code》Statement《/code》 object named 《code》$chanwGetDatabaseStatement《/code》
associated with the Cascade database. This macro is used by other macros.《/p》
《/documentation》
《macro id=“chanwGetDatabaseStatement”》
*#
#macro( chanwGetDatabaseStatement )
    #set( $chanwGetDatabasStatement = "" )
    #chanwGetObjectByClassName( "javax.naming.InitialContext" )
    #set( $chanwContext    = $chanwGetObjectByClassName )
    #set( $chanwDataSource = $chanwContext.lookup( "java:comp/env" ).lookup(
        "jdbc/CascadeDS" ) )
    #set( $chanwConnection = $chanwDataSource.Connection )
    #set( $chanwMetaData   = $chanwConnection.MetaData )
    #set( $chanwGetDatabaseStatement = $chanwConnection.createStatement( 
        $_FieldTool.in( "java.sql.ResultSet" ).TYPE_SCROLL_INSENSITIVE, 
        $_FieldTool.in( "java.sql.ResultSet" ).CONCUR_READ_ONLY ) )
#end
#*
《/macro》
《documentation》
《code》#chanwGetHTMLTableFromResultSet( $rs )《/code》
《p》Creates an XHTML table out of the result set. The resulting table is stored
in 《code》$globalStringBuffer《/code》. This macro is used by
《code》#chanwGetHTMLTableFromSql《/code》.《/p》
《/documentation》
《macro id=“chanwGetHTMLTableFromResultSet”》
*#
#macro( chanwGetHTMLTableFromResultSet $rs )
    #chanwCheckResultSet( $rs )
    $globalStringBuffer.setLength( 0 )
    
    #set( $chanwResultSetMetadata    = $rs.MetaData )
    #set( $chanwResultSetColumnCount = $chanwResultSetMetadata.ColumnCount )
        
    #set( $void = $globalStringBuffer.append(
        "<table class='tcellspacing1 tcellpadding5' summary='Table'>" ) )
    #set( $void = $globalStringBuffer.append(
        "<tr class='bg1 text_white'>" ) )

    #foreach( $col in [ 1..$chanwResultSetColumnCount ] )
        #set( $void = $globalStringBuffer.append( "<th>" ) )
        #set( $void = $globalStringBuffer.append(
            $chanwResultSetMetadata.getColumnName( $col ) ) )
        #set( $void = $globalStringBuffer.append( "</th>" ) )
    #end

    #set( $void = $globalStringBuffer.append( "</tr>" ) )
    $rs.beforeFirst()
        
    #foreach( $counter in [ 1..$INTEGER_MAX_VALUE ] )
        #if( $rs.next() )
            #if( $counter % 2 == 0 )
                #set( $void = $globalStringBuffer.append( "<tr>" ) )
            #else
                #set( $void = $globalStringBuffer.append(
                    "<tr class='tablerow1'>" ) )
            #end
                
            #foreach( $col in [ 1..$chanwResultSetColumnCount ] )
                #set( $void = $globalStringBuffer.append( "<td>" ) )
                #set( $void = $globalStringBuffer.append(
                    $rs.getString( $col ) ) )
                #set( $void = $globalStringBuffer.append( "</td>" ) )
            #end
                
            #set( $void = $globalStringBuffer.append( "</tr>" ) )
        #else
            #break
        #end
    #end

    #set( $void = $globalStringBuffer.append( "</table>" ) )
#end
#*
《/macro》
《documentation》
《code》#chanwGetHTMLTableFromSql( $sql )《/code》
《p》Creates an XHTML table out of the result set associated with the SQL statement.
The resulting table is stored in 《code》$chanwGetHTMLTableFromSql《/code》. Example:《/p》
《pre》
#set( $sql = "SELECT tablespace_name, table_name FROM all_tables " +
             "WHERE tablespace_name LIKE 'C%' " +
             "AND table_name like 'CXML_%' " +
             "ORDER BY table_name" )
#chanwGetHTMLTableFromSql( $sql )
$chanwGetHTMLTableFromSql
《/pre》
《/documentation》
《macro id=“chanwGetHTMLTableFromSql”》
*#
#macro( chanwGetHTMLTableFromSql $sql )
    #if( !$chanwGetDatabasStatement )
        #chanwGetDatabaseStatement()
        #chanwCheckStatement( $chanwGetDatabaseStatement )
    #end
    
    #chanwCheckString( $sql "An SQL string is required." )
    #chanwGetResultSet( $sql )
    
    #if( $chanwGetResultSet != "" )
        #chanwGetHTMLTableFromResultSet( $chanwGetResultSet )
    #end
    #set( $chanwGetHTMLTableFromSql = $globalStringBuffer.toString() )
#end
#*
《/macro》
《documentation》
《code》#chanwGetMetaDataRS( $table )《/code》
《p》Creates a 《code》ResultSet《/code》 object named 《code》$chanwGetMetaDataRS《/code》
associated with the Cascade database. This macro is used by other macros.《/p》
《p》Using the 《code》$chanwGetMetaDataRS《/code》 object:《/p》
《pre》
#set( $metaData = $chanwGetMetaDataRS.MetaData )

#foreach( $col in [ 1..$columnCount ] )
    $metaData.getColumnLabel( $col )
#end
《/pre》
《p》This outputs:《/p》
《pre》
    TABLE_CAT
    TABLE_SCHEM
    TABLE_NAME
    COLUMN_NAME
    DATA_TYPE
    TYPE_NAME
    COLUMN_SIZE
    BUFFER_LENGTH
    DECIMAL_DIGITS
    NUM_PREC_RADIX
    NULLABLE
    REMARKS
    COLUMN_DEF
    SQL_DATA_TYPE
    SQL_DATETIME_SUB
    CHAR_OCTET_LENGTH
    ORDINAL_POSITION
    IS_NULLABLE
    SCOPE_CATALOG
    SCOPE_SCHEMA
    SCOPE_TABLE
    SOURCE_DATA_TYPE
    IS_AUTOINCREMENT
《/pre》
《p》These column labels can be used to retrieve values from 《code》$chanwGetMetaDataRS《/code》.
See 《code》#chanwGetTableColumnNames《/code》 for example.《/p》
《/documentation》
《macro id=“chanwGetMetaDataRS”》
*#
#macro( chanwGetMetaDataRS $table )
    #if( !$chanwMetaData )
        Invoke chanwGetDatabaseStatement first.
        #stop
    #end
    
    #set( $chanwGetMetaDataRS = $chanwMetaData.getColumns( null, null, $table, "%" ) )
#end
#*
《/macro》
《documentation》
《code》#chanwGetNumberOfRecordsInResultSet( $rs )《/code》
《p》Returns the number of records in the result set. The returned value is stored in 
the global variable 《code》$chanwGetNumberOfRecordsInResultSet《/code》. Example:《/p》
《pre》
#set( $sql  = "SELECT userName, email, fullName FROM cxml_user" )
#chanwGetResultSet( $sql )
#chanwGetNumberOfRecordsInResultSet( $chanwGetResultSet )
$chanwGetNumberOfRecordsInResultSet
《/pre》
《/documentation》
《macro id=“chanwGetNumberOfRecordsInResultSet”》
*#
#macro( chanwGetNumberOfRecordsInResultSet $rs )
    #chanwCheckResultSet( $rs )
    #set( $chanwGetNumberOfRecordsInResultSet = 0 )

    #if( $rs.next() )
        $rs.beforeFirst()
        
        #foreach( $count in [ 1..$INTEGER_MAX_VALUE ] )
            #if( $rs.next() )
                #set( $chanwGetNumberOfRecordsInResultSet = $foreach.count )
            #else
                #break
            #end
        #end
        ## move cursor back to the front
        $rs.beforeFirst()
    #end
#end
#*
《/macro》
《documentation》
《code》#chanwGetNumberOfRecordsInTable( $table )《/code》
《p》Returns the number of records in the table. The returned value is stored in 
the global variable 《code》$chanwGetNumberOfRecordsInTable《/code》. Example:《/p》
《pre》
#chanwGetNumberOfRecordsInTable( "CXML_ACLENTRY" )
$chanwGetNumberOfRecordsInTable
《/pre》
《/documentation》
《macro id=“chanwGetNumberOfRecordsInTable”》
*#
#macro( chanwGetNumberOfRecordsInTable $table )
    #if( !$chanwGetDatabasStatement )
        #chanwGetDatabaseStatement()
        #chanwCheckStatement( $chanwGetDatabaseStatement )
    #end
    
    #chanwCheckString( $table "A table name is required." )
    
    #set( $chanwSql       = "SELECT count(*) FROM $table " )
    #set( $chanwResultSet = $chanwGetDatabaseStatement.executeQuery( $chanwSql ) )

    #if( $chanwResultSet.next() )
        #set( $chanwGetNumberOfRecordsInTable = $globalApacheMathTool.toNumber(
            $chanwResultSet.getString( 1 ) ) )
    #end
#end
#*
《/macro》
《documentation》
《code》#chanwGetResultSet( $sql )《/code》
《p》Returns the result set associated with the SQL statement. The result set is stored in
《code》$chanwGetResultSet《/code》. Example:《/p》
《pre》
#chanwGetResultSet( "SELECT count(*) FROM CXML_ASSETFACTORY" )
《/pre》
《/documentation》
《macro id=“chanwGetResultSet”》
*#
#macro( chanwGetResultSet $sql )
    #if( !$chanwGetDatabasStatement )
        #chanwGetDatabaseStatement()
        #chanwCheckStatement( $chanwGetDatabaseStatement )
    #end
    
    #chanwCheckString( $sql "An SQL string is required." )
    
    #set( $chanwGetResultSet = "" )
    #set( $chanwGetResultSet = $chanwGetDatabaseStatement.executeQuery( $sql ) )
    
    #if( !$chanwGetResultSet )
        No result set returned
    #end
#end
#*
《/macro》
《documentation》
《code》#chanwGetTableColumnNames( $table )《/code》
《p》Returns a list of column names of the table. Note that the table name must
in uppercase like "CXML_XML".《/p》
《pre》
#chanwGetTableColumnNames( "CXML_SITE" )
$chanwGetTableColumnNames
《/pre》
《/documentation》
《macro id=“chanwGetTableColumnNames”》
*#
#macro( chanwGetTableColumnNames $table )
    #chanwGetDatabaseStatement
    #chanwGetMetaDataRS( $table )
    #set( $chanwGetTableColumnNames = [] )

    #foreach( $row in [ 1..500 ] )
        #if( $chanwGetMetaDataRS.next() )
            #set( $chanwColumnName = '"' + $chanwGetMetaDataRS.getString( "COLUMN_NAME" ).toLowerCase() + '"' )
            #set( $void = $chanwGetTableColumnNames.add( $chanwColumnName ) )
        #else
            #break
        #end
    #end
    
    #if( $chanwGetTableColumnNames.size() == 0 )
        #set( $chanwSql = "select * from $table where 1 = 0" )
        #chanwGetResultSet( $chanwSql )
        #set( $chanwResultSetMetadata = $chanwGetResultSet.getMetaData() )
        #set( $chanwResultSetMetadataColumnCount = $chanwResultSetMetadata.getColumnCount() )
        
        #foreach( $num in [ 1..$chanwResultSetMetadataColumnCount ] )
            #set( $chanwColumnName = '"' + $chanwResultSetMetadata.getColumnLabel( $num ).toLowerCase() + '"' )
            #set( $void = $chanwGetTableColumnNames.add( $chanwColumnName ) )
        #end
    #end
#end
#*
《/macro》
《documentation id=“bottom”》
《/documentation》
《/code》
*#