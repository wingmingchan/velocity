#*
《code》
《documentation id=“top”》
《p》This format defines macros to process XML.
Use this format to process any 《code》system-data-structure《/code》 element or
any node without a fixed structure.
Use 《code》chanw_process_index_block《/code》 to process a page/folder created
by an index block.《/p》
《/documentation》
*#
#import( '/formats/library/velocity/chanw_global_values' )
## clean up the data structures
#chanwCleanUpMaps
#*
#set( $page_sdd = $_XPathTool.selectSingleNode( $contentRoot, "calling-page/system-page/system-data-structure" ) )
#chanwProcessSystemDataStructure( $page_sdd )
#chanwDisplayMapKeyValuePairs( $chanwXmlXPathTextMap true )
*#
#*
《documentation》
《p》Processes a 《code》system-data-structure《/code》 object (a 《code》org.jdom.Element《/code》 object). This can be the entry point of the library format.《/p》
《pre》
《/pre》
《/documentation》
《macro id=“chanwProcessSystemDataStructure”》
*#
#macro( chanwProcessSystemDataStructure $element )
    #if( $element.Name != $cascadeXML_ELEMENT_SYSTEM_DATA_STRUCTURE )
        Not a $cascadeXML_ELEMENT_SYSTEM_DATA_STRUCTURE!!!$BR
        #stop
    #end
    
    ## store empty string for text value
    #if( !$chanwXmlXPathTextMap.containsKey( $element.Name ) )
        #set( $void = $chanwXmlXPathTextMap.put( $element.Name, '' ) )
    #end
    
    ## store the current node path
    #if( !$chanwNodeInfoMap.containsKey( $element ) )
        #set( $void = $chanwNodeInfoMap.put( $element, $element.Name ) )
    #end
    
    #chanwProcessJdomElement( $element )
#end
#*
《/macro》
《documentation》
《p》《/p》
《pre》

《/pre》
《/documentation》
《macro id=“chanwProcessJdomElement”》
*#
#macro( chanwProcessJdomElement $node )
    #if( $node.Class.Name != $ORG_JDOM_ELEMENT_CLASS_NAME )
        Not an element!!!$BR
        #stop
    #end
    
    ## WYSIWYG
    ## allow two suffixes in the node name: content and wysiwyg
    #if( $node.Name.endsWith( "-content" ) || $node.Name.endsWith( "-wysiwyg" ) )
        ## get the parent path
        #set( $chanwNodePath = $chanwNodeInfoMap.get( $child.getParent() ) )
        ## create the path for current child
        #set( $chanwChildKey = $chanwNodePath + '/' + $child.Name )
    
        ##set( $chanwWYSIWYGPath  = $chanwNodeInfoMap.get( $child ) )
        #set( $chanwWYSIWYGValue = $_SerializerTool.serialize( $child, true ) )
        #set( $void = $chanwXmlXPathTextMap.put(
            $chanwChildKey, $chanwWYSIWYGValue ) )
    ## skip chooser
    #elseif( $node.Name == "content" )
        ## do nothing
    #elseif( $node.Children && $node.Children.size() > 0 )
        ##store the group path
        #set( $chanwParentNode = $node.getParent() )
        
        #if( $chanwParentNode && $chanwParentNode.Class.Name !=
            $ORG_JDOM_DOCUMENT_CLASS_NAME  )
            #set( $chanwParentPath = $chanwNodeInfoMap.get( $chanwParentNode ) + '/' )
        #else
            #set( $chanwParentPath = "" )
        #end
        
        #set( $chanwCurrentNodePath = $chanwParentPath + $node.Name )
        
        #if( !$chanwNodeInfoMap.containsKey( $node ) )
            #set( $void = $chanwNodeInfoMap.put( $node ) )
        #end
    
        #foreach( $child in $node.Children )
            ## skip chooser
            ##if( $node.Name == "content" )
                ## do nothing
            ##else
                ## test for WYSIWYG
                #set( $chanwIsWYSIWYG = false )
                ## allow two suffixes in the node name: content and wysiwyg
                #if( $node.Name.endsWith( "-content" ) || $node.Name.endsWith( "-wysiwyg" ) )
                    #set( $chanwIsWYSIWYG = true )
                #end
        
                #if( $chanwIsWYSIWYG == false )
                    ## get the parent path
                    #set( $chanwNodePath = $chanwNodeInfoMap.get( $child.getParent() ) )
                    ## create the path for current child
                    #set( $chanwChildKey = $chanwNodePath + '/' + $child.Name )
                    ## select all children bearing the same name
                    #set( $nodes = $_XPathTool.selectNodes( $child.getParent(), $child.Name ) )
            
                    ## multiple nodes
                    #if( $nodes.size() > 1 )
                        #set( $chanwSize = 0 )
                    
                        #foreach( $n in $nodes )
                            #if( $chanwNodeInfoMap.containsKey( $n ) ) ## already processed
                                #break
                            #end
                
                            ## create the correct XPath
                            #set( $tempChildKey = $chanwChildKey + "[$foreach.count]" )
                            ## store node-path pair
                            #if( !$chanwNodeInfoMap.containsKey( $n ) )
                                #set( $void = $chanwNodeInfoMap.put( $n, $tempChildKey ) )
                            #end
                            #set( $chanwSize = $foreach.count )
                        
                        #end
                    
                        #if( !$chanwNodeInfoMap.containsKey( $chanwChildKey ) )
                            #set( $void = $chanwNodeInfoMap.put( $chanwChildKey, { 'size':$chanwSize } ) )
                        #end
                    ## single node
                    #else
                        #set( $chanwParentNode = $child.getParent() )
                        #set( $chanwParentPath = $chanwNodeInfoMap.get( $chanwParentNode ) )
                        #set( $chanwChildPath  = $chanwParentPath + '/' + $child.Name )
                    
                        #if( !$chanwNodeInfoMap.containsKey( $child ) )
                            #set( $void = $chanwNodeInfoMap.put( $child, $chanwChildPath ) )
                        #end
                    #end
            
                    ## group
                    #if( $child.Children && $child.Children.size() > 0 )
                        #set( $void = $chanwXmlXPathTextMap.put( $chanwNodeInfoMap.get( $child ), '' ) )
                        ##set( $tempChildKey = $chanwNodeInfoMap.get( $child ) )
                        ## recursive call
                        #chanwProcessJdomElement( $child )
                        ##set( $tempChildKey = "" )
                    ## text field
                    #elseif( $child.Value )
                        ## get the parent path
                        #set( $chanwParentPath = $chanwNodeInfoMap.get( $child.getParent() ) )
                        #set( $chanwChildPath  = $chanwParentPath + '/' + $child.Name )
                
                        #if( !$chanwNodeInfoMap.containsKey( $child ) )
                            #set( $void = $chanwNodeInfoMap.put( $child, $chanwChildPath ) )
                        #end
                
                        #processTextNode( $child  )
                    #end
                #else
                    ## get the parent path
                    #set( $chanwNodePath = $chanwNodeInfoMap.get( $child.getParent() ) )
                    ## create the path for current child
                    #set( $chanwChildKey = $chanwNodePath + '/' + $child.Name )
                
                    ##set( $chanwWYSIWYGPath  = $chanwNodeInfoMap.get( $child ) )
                    #set( $chanwWYSIWYGValue = $_SerializerTool.serialize( $child, true ) )
                    #set( $void = $chanwXmlXPathTextMap.put(
                        $chanwChildKey, $chanwWYSIWYGValue ) )
                #end
            ##end
        #end
    #else
        $node.Name$BR
        Nothing to process.$BR
    #end
#end
#*
《/macro》
《documentation》
《p》《/p》
《pre》

《/pre》
《/documentation》
《macro id=“processTextNode”》
*#
#macro( processTextNode $node  )
    #set( $chanwTextNodePath  = $chanwNodeInfoMap.get( $node ) )
    #set( $chanwTextNodeValue = $node.Value )
    
    ## asset chooser
    #if( $chanwTextNodeValue == '/' )
        #set( $chanwTextNodeValue = '' )
    #end

    #set( $void = $chanwXmlXPathTextMap.put( 
        $chanwTextNodePath, $_EscapeTool.xml( $chanwTextNodeValue ) ) )
#end
#*
《/macro》
《documentation》
《p》《/p》
《pre》

《/pre》
《/documentation》
《macro id=“chanwCleanUpMaps”》
*#
#macro( chanwCleanUpMaps )
    #set( $chanwXmlXPathTextMap = {} ) ## storing data
    #set( $chanwNodeInfoMap     = {} ) ## storing node information
#end
#*
《/macro》
《documentation》
《p》《/p》
《pre》

《/pre》
《/documentation》
《macro id=“chanwDisplayMapKeys”》
*#
#macro( chanwDisplayMapKeys $map $trimRoot )
    #if( $map.Class.Name == $JAVA_UTIL_LINKEDHASHMAP_CLASS_NAME )
        #foreach( $key in $map.keySet() )
            #if( $trimRoot && $key.Class.Name == $JAVA_LANG_STRING_CLASS_NAME )
                #set( $chanwFirstSlashPos = $key.indexOf( '/' ) + 1 )
                
                #if( $chanwFirstSlashPos < 1 )
                    ## nothing to do
                #else
                    #set( $tempKey = $key.substring( $chanwFirstSlashPos ) )
                    $tempKey$BR
                #end
            #elseif( $key.Class.Name == $JAVA_LANG_STRING_CLASS_NAME )
                $key$BR
            #end
        #end
    #else
        Not a map!!!$BR
    #end
#end
#*
《/macro》
《documentation》
《p》《/p》
《pre》

《/pre》
《/documentation》
《macro id=“chanwDisplayMapKeyValuePairs”》
*#
#macro( chanwDisplayMapKeyValuePairs $map $trimRoot )
    #if( $map.Class.Name == $JAVA_UTIL_LINKEDHASHMAP_CLASS_NAME )
        #foreach( $key in $map.keySet() )
            #if( $trimRoot && $key.Class.Name == $JAVA_LANG_STRING_CLASS_NAME )
                #set( $chanwFirstSlashPos = $key.indexOf( '/' ) + 1 )
                
                #if( $chanwFirstSlashPos < 1 )
                    ## nothing to do
                #else
                    #set( $tempKey = $key.substring( $chanwFirstSlashPos ) )
                    $tempKey: $map.get( $key )$BR
                #end
            #else
                $key: $map.get( $key )$BR
            #end
        #end
    #else
        Not a map!!!$BR
    #end
#end
#*
《/macro》
《documentation》
《p》Shows the block XML. 《code》$block_xml《/code》 should be an Element object.《/p》
《pre》
《/pre》
《/documentation》
《macro id=“chanwShowXml”》
*#
#macro( chanwShowXml $block_xml $with_pre $with_newline )
#set( $chanwXmlString = $_SerializerTool.serialize( $block_xml, false ) )
#chanwShowXmlString( $chanwXmlString $with_pre $with_newline )
#end
#*
《/macro》
《documentation》
《p》Displays an XML string, possibly formatted.《/p》
《pre》
《/pre》
《/documentation》
《macro id=“chanwShowXmlString”》
*#
#macro( chanwShowXmlString $xml_string $with_pre $with_newline )
#if( $with_pre )$S_PRE#end##
#if( $with_newline )
#set( $chanwXmlString = $xml_string.replaceAll( "<", "$NEWLINE&lt;" ) )##
#else
#set( $chanwXmlString = $xml_string.replaceAll( "<", "&lt;" ) )##
#end##
$chanwXmlString
#if( $with_pre )$E_PRE#end
#end
#*
《/macro》
《documentation id=“bottom”》
《/documentation》
《/code》
*#