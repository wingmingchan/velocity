#*
《code》
《copyright》
Author: Wing Ming Chan
Copyright (c) 2017 Wing Ming Chan <chanw@upstate.edu>
MIT Licensed
Modification history:
5/17/2017 Added more tests to #chanwDisplayClassAPI.
4/7/2017 Added more annotations.
《/copyright》
《documentation id=“top”》
《h2》Introduction《/h2》
《p》This format provides utility macros for reflection and displaying
class API. It can be used to generate documentation pages, like those in
http://www.upstate.edu/cascade-admin/formats/velocity/api-documentation/index.php.
The 《code》#chanwDisplayClassAPI《/code》 macro can accept three params,
the second and third are optional. Example:《/p》
《pre》
#chanwDisplayClassAPI( "java.lang.Math", "h3", "true" ) ## pass in a class name
#chanwDisplayClassAPI( $_, "h3", "true" )               ## pass in an object
#chanwDisplayClassAPI( $_.Class, "h3", "true" )         ## pass in a java.lang.Class object
#chanwDisplayClassAPI( $_ )                             ## pass in an object
《/pre》
《p》For a class name like "java.util.HashMap&lt;K, V&gt;", pass in the string
"java.util.LinkedHashMap,K,V" as the class name:《/p》
《pre》
#chanwDisplayClassAPI( "java.util.HashMap,K,V" ) ## pass in a class name with commas
《/pre》
《/documentation》
*#
#import( '/formats/library/velocity/chanw_object_creator' )
#import( '/formats/library/velocity/chanw_global_values' )
#*
《global-variables》
*#
#set( $chanwReflectUtilitiesGlobalVariables = [
    "chanwClassObj",
    "chanwClassString",
    "chanwConstructors",
    "chanwHeading",
    "chanwIndex",
    "chanwMethods",
    "chanwModifier",
    "chanwObjString",
    "chanwObjType",
    "chanwParamTypes",
    "chanwParamTypesString",
    "chanwReturnType",
    "chanwSuffix",
    "chanwWithH2"
] )
#*
《/global-variables》
《documentation》
《code》#chanwDisplayClassAPI( $obj $heading $withH2 )《/code》
《p》Displays essential information of a class, including a list of constructors
and methods. This macro only sets up parameters, possibly with default values,
and invokes 《code》#chanwDisplayObjClass《/code》. Use this macro as the entry
point to this library format.《/p》
《/documentation》
《macro id=“chanwDisplayClassAPI”》
*#
#macro( chanwDisplayClassAPI $obj $heading $withH2 )
    #if( $_PropertyTool.isNull( $obj ) )
        No parameter supplied.
        #stop
    #end
    
    #if( !$heading || $heading.Class.Name != $JAVA_LANG_STRING_CLASS_NAME || $heading == "" )
        #set( $chanwHeading = "h3" )
    #else
        #set( $chanwHeading = $heading )
    #end
    
    #if( !$withH2 || $withH2.Class.Name != $JAVA_LANG_BOOLEAN_CLASS_NAME )
        #set( $chanwWithH2 = true )
    #else
        #set( $chanwWithH2 = $withH2 )
    #end
    
    #chanwDisplayObjClass( $obj $chanwHeading $chanwWithH2 )
#end
#*
《/macro》
《documentation》
《code》#chanwDisplayObjClass( $obj $heading $withH2 )《/code》
《p》Calls other macros and displays class API information.《/p》
《/documentation》
《macro id=“chanwDisplayObjClass”》
*#
#macro( chanwDisplayObjClass $obj $heading $withH2 )
    #set( $chanwObjString = "" )
    #set( $chanwObjType = $obj.Class.Name )
 
    #if( $chanwObjType == $JAVA_LANG_STRING_CLASS_NAME )    ## class name
        #set( $chanwObjString = $obj )
    #elseif( $chanwObjType == $JAVA_LANG_CLASS_CLASS_NAME ) ## class obj
        #set( $chanwObjString = $obj.Name )
    #else                                              ## obj of other types
        #set( $chanwObjString = $obj.Class.Name )
    #end
    
    #set( $chanwSuffix = "" )
    #set( $chanwClassString = $chanwObjString )
    
    ## to deal with a class name like "java.util.HashMap,K,V"
    #if( $chanwObjString.indexOf( "," ) > -1 )
        #set( $chanwIndex = $chanwObjString.indexOf( "," ) )
        #set( $chanwClassString = $chanwObjString.substring( 0, $chanwIndex ) )
        #set( $chanwSuffix = $chanwObjString.substring( $chanwIndex ) )
        #set( $chanwSuffix = $chanwSuffix.substring( 1 ) ) ## remove comma
        #set( $chanwSuffix = "&lt;" + $chanwSuffix + "&gt;" )
    #end
    
    #if( $withH2 )$S_H2$chanwClassString$chanwSuffix$E_H2#end
   
    #chanwDisplaySuperClass( $chanwClassString $heading )
    #chanwDisplayFields( $chanwClassString $heading )
    #chanwDisplayConstructors( $chanwClassString $heading )
    #chanwDisplayMethods( $chanwClassString $heading )
    $HR
#end
#*
《/macro》
《documentation》
《code》#chanwDisplayConstructors( $obj $heading )《/code》
《p》Displays a list of constructors.《/p》
《/documentation》
《macro id=“chanwDisplayConstructors”》
*#
#macro( chanwDisplayConstructors $obj $heading )
    #set( $chanwObjType = $obj.Class.Name )
    
    #if( $chanwObjType == $JAVA_LANG_STRING_CLASS_NAME )    ## class name
        #set( $chanwClassObj = $_PropertyTool.class.forName( $obj ) )
    #elseif( $chanwObjType == $JAVA_LANG_CLASS_CLASS_NAME ) ## class obj
        #set( $chanwClassObj = $obj )
    #else  ## obj of other types
        #set( $chanwClassObj = $obj.Class )
    #end
    
    #if( $chanwClassObj )
        #set( $chanwConstructors = $chanwClassObj.getConstructors() )
        
        #if( $chanwConstructors && $chanwConstructors.size() > 0 )
            <$heading>Constructors</$heading>
            $S_UL
            #foreach( $constructor in $chanwConstructors )
                $S_LI$_.class.forName( "java.lang.reflect.Modifier" ).getMethod( 
                    "toString", $_FieldTool.in( 
                    "java.lang.Integer" ).TYPE ).invoke( 
                    null, $constructor.getModifiers() ) $constructor.Name
                    
                #set( $chanwParamTypes = $constructor.getGenericParameterTypes() )
                #set( $chanwParamTypesString = "( " )

                #if( $chanwParamTypes && $chanwParamTypes.size() > 0 )
                    #foreach( $chanwParamType in $chanwParamTypes )
                        #if( $chanwParamType.Name )
                            #set( $chanwParamTypesString = $chanwParamTypesString + 
                                $chanwParamType.Name )
                        #elseif( $chanwParamType.getTypeName() )
                            #set( $chanwParamTypesString = $chanwParamTypesString + 
                                $chanwParamType.getTypeName().replaceAll( "<", "&lt;" ) )
                        #end
                        #if( $foreach.count < $chanwParamTypes.size() )
                            #set( $chanwParamTypesString = $chanwParamTypesString + ", " )
                        #end
                    #end
                #end
                
                #set( $chanwParamTypesString = $chanwParamTypesString + " )" )
                #set( $chanwParamTypesString = $chanwParamTypesString.trim() )
                $chanwParamTypesString$E_LI
            #end
            $E_UL
        #else
            ## No constructors found.
        #end
    #else
        ## No constructors found.
    #end
#end
#*
《/macro》
《documentation》
《code》#chanwDisplayMethods( $obj $heading )《/code》
《p》Displays a list of methods.《/p》
《/documentation》
《macro id=“chanwDisplayMethods”》
*#
#macro( chanwDisplayMethods $obj $heading )
    #set( $chanwObjType = $obj.Class.Name )
    
    #if( $chanwObjType == $JAVA_LANG_STRING_CLASS_NAME )    ## class name
        #set( $chanwClassObj = $_PropertyTool.class.forName( $obj ) )
    #elseif( $chanwObjType == $JAVA_LANG_CLASS_CLASS_NAME ) ## class obj
        #set( $chanwClassObj = $obj )
    #else                                              ## obj of other types
        #set( $chanwClassObj = $obj.Class )
    #end
    
    #if( $chanwClassObj )
        #set( $chanwMethods = $chanwClassObj.getDeclaredMethods() )
        
        #if( $chanwMethods && $chanwMethods.size() > 0 )
            <$heading>Methods</$heading>
            $S_UL
            #foreach( $method in $chanwMethods )
                $S_LI
                #set( $chanwModifier = $_.class.forName( "java.lang.reflect.Modifier" ).getMethod( 
                    "toString", $_FieldTool.in( 
                    "java.lang.Integer" ).TYPE ).invoke( 
                    null, $method.getModifiers() ) )
                    
                    #set( $chanwReturnType = 
                        $method.getGenericReturnType().getTypeName().replaceAll(
                            "<", "&lt;" ).trim() )
                    
                    #set( $chanwParamTypes = $method.getGenericParameterTypes() )
                    #set( $chanwParamTypesString = $chanwModifier + " " + 
                         $chanwReturnType + " " + $method.Name.trim() + "( " )
                    
                    #if( $chanwParamTypes && $chanwParamTypes.size() > 0 )
                        #foreach( $chanwParamType in $chanwParamTypes )
                            #if( $chanwParamType.Name )
                                #set( $chanwParamTypesString = $chanwParamTypesString + $chanwParamType.Name )
                            #elseif( $chanwParamType.getTypeName() )
                                #set( $chanwParamTypesString = $chanwParamTypesString + 
                                    $chanwParamType.getTypeName().replaceAll( "<", "&lt;" ) )
                            #end
                            
                            #if( $foreach.count < $chanwParamTypes.size() )
                                #set( $chanwParamTypesString = $chanwParamTypesString + ", " )
                            #end
                        #end
                    #end
                    
                    #set( $chanwParamTypesString = $chanwParamTypesString + " )" )
                    #set( $chanwParamTypesString = " " + $chanwParamTypesString.trim() )
                    #set( $chanwParamTypesString = $chanwParamTypesString.replaceAll( " \(", "(" ) )
                     $chanwParamTypesString
                $E_LI
            #end
            $E_UL
        #else
            ## No methods.
        #end
    #end
#end
#*
《/macro》
《documentation》
《code》#chanwDisplayFields( $obj $heading )《/code》
《p》Displays a list of fields and values.《/p》
《/documentation》
《macro id=“chanwDisplayFields”》
*#
#macro( chanwDisplayFields $obj $heading )
    #set( $chanwObjType = $obj.Class.Name )
    
    #if( $chanwObjType == $JAVA_LANG_STRING_CLASS_NAME )    ## class name
        #set( $chanwClassObj = $_PropertyTool.class.forName( $obj ) )
    #elseif( $chanwObjType == $JAVA_LANG_CLASS_CLASS_NAME ) ## class obj
        #set( $chanwClassObj = $obj )
    #else                                              ## obj of other types
        #set( $chanwClassObj = $obj.Class )
    #end
    
    #if( $chanwClassObj )
        #set( $chanwFields = $chanwClassObj.getFields() )
        
        #if( $chanwFields && $chanwFields.size() > 0 )
            <$heading>Fields</$heading>
            $S_UL
            #foreach( $field in $chanwFields )
                $S_LI$field.getName().replaceAll( '&', '&amp;' ):
                $_EscapeTool.xml( $field.get( null ) )$E_LI
            #end
            $E_UL
        #else
            ## No fields.
        #end
    #end
#end
#*
《/macro》
《documentation》
《code》#chanwDisplaySuperClass( $obj $heading )《/code》
《p》Displays the parent class name.《/p》
《/documentation》
《macro id=“chanwDisplaySuperClass”》
*#
#macro( chanwDisplaySuperClass $obj $heading )
    #set( $chanwObjType = $obj.Class.Name )
    
    #if( $chanwObjType == $JAVA_LANG_STRING_CLASS_NAME )    ## class name
        #set( $chanwClassObj = $_PropertyTool.class.forName( $obj ) )
    #elseif( $chanwObjType == $JAVA_LANG_CLASS_CLASS_NAME ) ## class obj
        #set( $chanwClassObj = $obj )
    #else                                              ## obj of other types
        #set( $chanwClassObj = $obj.Class )
    #end
      
    #if( $chanwClassObj )
        #set( $chanwParent = $chanwClassObj.getGenericSuperclass() )
        
        #if( $chanwParent )
        <$heading>Parent Class</$heading>$S_P$chanwParent.toString().replaceAll( "<", "&lt;" )$E_P
        #end
    #end
#end
#*
《/macro》
《documentation id=“bottom”》
《/documentation》
《/code》
*#